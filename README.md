# Интеграция аудит логов с SIEM системами

## Структура проекта

```
auditlog-integration/
├── main.py          # Точка входа - композиция компонентов и управление жизненным циклом
├── config.py        # Класс Settings - загрузка и валидация конфигурации из .env
├── state.py         # StateManager - персистентное хранение токена и состояния курсора
├── auth.py          # AuthClient - аутентификация через Keystone API
├── client.py        # AuditLogClient - получение аудит логов из API
├── processor.py     # EventProcessor - дедупликация и сохранение событий
├── runner.py        # PollingRunner - основной цикл опроса API
├── savers.py        # Реализации транспортов для отправки событий
├── mock_syslog_server.py  # Тестовый syslog сервер
└── mock_http_server.py    # Тестовый HTTP сервер
```

### Описание модулей

| Модуль         | Ответственность                                     |
|----------------|-----------------------------------------------------|
| `config.py`    | Загрузка переменных окружения, валидация настроек   |
| `state.py`     | Сохранение токена и курсора в файлы                 |
| `auth.py`      | Аутентификация в Selectel Keystone API              |
| `client.py`    | Запросы к API аудит логов                           |
| `processor.py` | Логика дедупликации и сохранения событий            |
| `runner.py`    | Оркестрация цикла опроса                            |
| `savers.py`    | Транспорты: `FileSaver`, `SyslogSaver`, `HttpSaver` |

## Что и где хранится

В процессе работы скрипт создает несколько файлов для хранения состояния и данных:

- **token.txt** - содержит токен аутентификации Selectel (X-Subject-Token), используется для минимизации запросов на аутентификацию
- **last_event.txt** — хранит информацию о последнем обработанном событии (`event_id`, `event_saved_time`, `cursor`) для предотвращения дублирования при перезапуске
- **events.txt** — журнал всех обработанных событий в формате JSON (по одному событию на строку). Создается только при использовании `FileSaver` (когда `TRANSPORT_TYPE=file`)

**Важно:** Скрипт требует разрешения на создание и запись файлов в рабочей директории вне зависимости от типа транспорта (file/syslog/http), так как файлы состояния (`token.txt`, `last_event.txt`) необходимы для корректной работы.

## Установка окружения

Для начала нужно создать виртуальное окружение:

```
python3 -m venv .venv
```


Затем активировать его:
```
source .venv/bin/activate
```

После активации окружения установите необходимые зависимости:

```
pip3 install -r requirements.txt
```

## Подготовка к запуску:

Для начала нужно создать файл `.env` с переменными окружения:

```
touch .env
```

Чтобы можно было его заполнить — нужно создать сервисного пользователя в панели Selectel с ролью `member`

Затем нужно заполнить файл `.env`:

```
# Обязательные параметры для доступа к API Selectel
AUDIT_LOGS_URL=https://api.selectel.ru/audit-logs/v1/logs
USERNAME=<Имя сервисного пользователя созданного выше>
PASSWORD=<Пароль сервисного пользователя созданного выше, если в пароле есть символы, которые требуют экранирования, то их нужно экранировать>
ACCOUNT_ID=<Ваш номер аккаунта>

# Тип транспорта для отправки событий (выберите один: file, syslog, http)
TRANSPORT_TYPE=file

# Интервал опроса API в секундах (по умолчанию 30)
POLL_INTERVAL=30

# Настройки для syslog транспорта (обязательны если TRANSPORT_TYPE=syslog)
SYSLOG_HOST=127.0.0.1
SYSLOG_PORT=5514

# Настройки для HTTP транспорта (обязательны если TRANSPORT_TYPE=http)
HTTP_URL=http://localhost:8080/events
HTTP_USERNAME=admin
HTTP_PASSWORD=secret
HTTP_VERIFY_SSL=true
```

Скрипт для интеграции и скачивания аудит логов может работать в 3 режимах:
- **file** — Сохранение аудит логов в файл `events.txt` (по умолчанию)
- **syslog** - Отправка событий в syslog сервер через UDP
- **http** - Отправка событий на HTTP endpoint с Basic Auth аутентификацией

## Запуск скрипта

Для запуска нужно выполнить команду:
```
python3 main.py
```

## Тестирование транспортов

### Тестирование Syslog транспорта

Для теста интеграции с syslog можно использовать тестовый syslog сервер:

```bash
python3 mock_syslog_server.py [порт]
```

Сервер запустится на порту 5514 (или указанном порту) и будет выводить все полученные сообщения.

Для использования установите `TRANSPORT_TYPE=syslog` в файле `.env`.

### Тестирование HTTP транспорта

Для теста интеграции с HTTP можно использовать тестовый HTTP сервер:

```bash
python3 mock_http_server.py [порт]
```

Сервер запустится на порту 8080 (или указанном порту) и будет:
- Принимать POST запросы с JSON данными
- Проверять Basic Auth аутентификацию (по умолчанию: admin/secret)
- Выводить полученные события в консоль

Для использования установите `TRANSPORT_TYPE=http` в файле `.env` и настройте параметры HTTP_URL, HTTP_USERNAME и HTTP_PASSWORD.
